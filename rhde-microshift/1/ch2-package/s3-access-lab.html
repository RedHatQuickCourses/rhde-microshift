<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Lab: Access MicroShift as a Developer or Platform Engineer :: Deploying MicroShift on Red Hat Device Edge</title>
    <link rel="prev" href="s2-install-lab.html">
    <link rel="next" href="../ch3-image/index.html">
    <meta name="generator" content="Antora 3.1.3">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <script>var uiRootPath = '../../../_'</script>
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://www.redhat.com" target="_blank"><img src="../../../_/img/redhat-logo.png" height="40px" alt="Red Hat"></a>
      <a class="navbar-item" style="font-size: 24px; color: white" href="../../..">Deploying MicroShift on Red Hat Device Edge</a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="https://github.com/RedHatQuickCourses/rhde-microshift/issues" target="_blank">Report Issues</a>
      </div>
    </div>
  </nav>
</header><div class="body">
<div class="nav-container" data-component="rhde-microshift" data-version="1">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ch1-microshift/index.html">Introduction to Red Hat Build of MicroShift</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Deploy MicroShift on RHEL Servers</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../ch3-image/index.html">Deploy MicroShift on Edge Devices</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">Deploying MicroShift on Red Hat Device Edge</span>
    <span class="version">1</span>
  </div>
  <ul class="components">
    <li class="component is-current">
      <a class="title" href="../index.html">Deploying MicroShift on Red Hat Device Edge</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">1</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../../samples/1/index.html">samples</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../../samples/1/index.html">1</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">Deploying MicroShift on Red Hat Device Edge</a></li>
    <li><a href="index.html">Deploy MicroShift on RHEL Servers</a></li>
    <li><a href="s3-access-lab.html">Lab: Access MicroShift as a Developer or Platform Engineer</a></li>
  </ul>
</nav>
</div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Lab: Access MicroShift as a Developer or Platform Engineer</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><em>Estimated reading time: <strong>5 minutes</strong>.</em></p>
</div>
<div class="dlist">
<dl>
<dt class="hdlist1">Objective</dt>
<dd>
<p>Configure remote access to MicroShift as privileged and unprivileged users.</p>
</dd>
</dl>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
Work In Progress
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_before_you_begin"><a class="anchor" href="#_before_you_begin"></a>Before you Begin</h2>
<div class="sectionbody">
<div class="paragraph">
<p>You need a <em>test machine</em> where you installed, configured, and verified MicroShift, by following the instructions from the <a href="s2-install-lab.html" class="xref page">previous lab</a>.</p>
</div>
<div class="paragraph">
<p>You also need a <em>development machine</em> from which you will access the MicroShift instance on your <em>test machine</em>.</p>
</div>
<div class="paragraph">
<p>Finally, you also need a <em>mirror registry</em> machine, already configured with a mirror registry for Red Hat OpenShift and pre-populared with container images required by MicroShift and applications samples. Make sure that your <em>mirror registry machine</em> machine was configured and verified by following the instructions from the <a href="#ch1-microshift:s3-prepare-lab.adoc" class="xref unresolved">first lab</a>.</p>
</div>
<div class="paragraph">
<p>These instructions were tested on RHEL 9.4 [tentative!] but should work with minimal or no change on newer and older RHEL 9.x releases.</p>
</div>
<div class="paragraph">
<p>If you are using the course classroom, you will log in on the <code>workstation</code> VM, which is your <em>development machine</em>, as the user <code>student</code> with password <code>student</code>, and you start SSH sessions from <code>workstation</code> VM to the <code>serverb</code> VM, which is your <em>test machine</em>, using the same user. If not, please adapt the instructions to your test environment.</p>
</div>
<div class="paragraph">
<p>You will perform all steps in this lab on your <em>test machine</em>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_instructions"><a class="anchor" href="#_instructions"></a>Instructions</h2>
<div class="sectionbody">
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Log in on your <em>test machine</em> and verify that MicroShift is up and running.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Check that the MicroShift service is active.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>sudo systemctl is-active microshift</strong>
active</code></pre>
</div>
</div>
</li>
<li>
<p>Check that all pods are running and all their containers are ready and all their containers are running</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --kubeconfig ~/local-admin get pod -A</strong>
NAMESPACE              	NAME                                   	READY   STATUS	RESTARTS    	AGE
kube-system            	csi-snapshot-controller-69ddff88c8-hr9dt   1/1 	Running   0           	6m37s
kube-system            	csi-snapshot-webhook-74dc497864-hfdw7  	1/1 	Running   0           	6m41s
openshift-dns          	dns-default-9z4ph                      	2/2 	Running   0           	5m55s
openshift-dns          	node-resolver-prvjx                    	1/1 	Running   0           	6m39s
openshift-ingress      	router-default-575b4fc7-tg5lz          	1/1 	Running   0           	6m37s
openshift-ovn-kubernetes   ovnkube-master-wj4gv                   	4/4 	Running   1 (5m57s ago)   6m39s
openshift-ovn-kubernetes   ovnkube-node-fdpm8                     	1/1 	Running   1 (5m58s ago)   6m39s
openshift-service-ca   	service-ca-9db855698-zd7vg             	1/1 	Running   0           	6m36s
openshift-storage      	lvms-operator-7f544467bc-cqf2n         	1/1 	Running   0           	6m40s
openshift-storage      	vg-manager-tjrs2                       	1/1 	Running   0           	5m25s</code></pre>
</div>
</div>
<div class="paragraph">
<p>Remember that you copied the autogenerated kubeconfig file to <code>~/local-admin</code> in the <a href="s2-install-lab.html" class="xref page">previous lab</a></p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Create a namespace and a service account with limited read-write access to that namespace.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>export KUBECONFIG=~/local-admin</strong>
$ <strong>oc create namespace user</strong>
namespace/user created
$ <strong>oc create sa user -n user</strong>
serviceaccount/user created
$ <strong>oc create rolebinding user --clusterrole edit --serviceaccount user:user -n user</strong></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --as system:serviceaccount:user:user get sa -n user</strong>
NAME      SECRETS   AGE
default   0         8m48s
user      0         6m58s
$ <strong>oc --as system:serviceaccount:user:user get sa -n default</strong>
Error from server (Forbidden): serviceaccounts is forbidden: User "system:serviceaccount:user:user" cannot list resource "serviceaccounts" in API group "" in the namespace "default"
$ <strong>oc --as system:serviceaccount:user:user get node</strong>
Error from server (Forbidden): nodes is forbidden: User "system:serviceaccount:user:user" cannot list resource "nodes" in API group "" at the cluster scope</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc --as system:serviceaccount:user:user create configmap test1 --from-literal one=1 -n user</strong>
NAME      SECRETS   AGE
default   0         8m48s
user      0         6m58s
$ <strong>oc get configmap -n user</strong>
NAME                       DATA   AGE
kube-root-ca.crt           1      15m
openshift-service-ca.crt   1      15m
test1                      1      11s</code></pre>
</div>
</div>
</li>
<li>
<p>Create another namespace and grant limited read-only access to the service account.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc create namespace project</strong>
namespace/project created
$ <strong>oc create rolebinding user --clusterrole view --serviceaccount user:user -n project</strong></code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>oc create configmap test2 --from-literal two=2 -n project</strong>
configmap/test2 created
$ <strong>oc --as system:serviceaccount:user:user get configmap -n project</strong>
NAME                       DATA   AGE
kube-root-ca.crt           1      89s
openshift-service-ca.crt   1      89s
test2                      1      35s
$ <strong>oc --as system:serviceaccount:user:user create configmap test3 --from-literal three=3 -n project</strong>
error: failed to create configmap: configmaps is forbidden: User "system:serviceaccount:user:user" cannot create resource "configmaps" in API group "" in the namespace "project"</code></pre>
</div>
</div>
</li>
<li>
<p>Create a kubeconfig file with the token for the service account.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ <strong>cat &lt;&lt;EOF &gt;user-token.yaml</strong>
apiVersion: v1
kind: Secret
metadata:
  name: user-token
  annotations:
    kubernetes.io/service-account.name: "user"
type: kubernetes.io/service-account-token
EOF
$ <strong>oc apply -f user-token.yaml -n user</strong>
secret/user-token created
$ <strong>mkdir temp-token</strong>
$ <strong>--keys token --to . -n user</strong>
token</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ unset KUBECONFIG
$ sudo cp /var/lib/microshift/resources/kubeadmin/serverb/kubeconfig ~/remote-admin
$ sudo chown student:student ~/remote-admin
$ chmod a-w ~/remote-admin
$ cp remote-admin remote-user
$ oc --kubeconfig ~/remote-user config delete-user user
deleted user user from /home/student/remote-user
$ oc --kubeconfig ~/remote-user config set-credentials user --token $(cat token)
User "user" set.
$ oc --kubeconfig ~/remote-user config set-context microshift --namespace user --user user --cluster microshift
Context "microshift" modified.
$ oc --kubeconfig ~/remote-user get configmap
NAME                       DATA   AGE
kube-root-ca.crt           1      107m
openshift-service-ca.crt   1      107m
test1                      1      92m</code></pre>
</div>
</div>
</li>
<li>
<p>Grant the unprivileged user rights to impersonate a cluster-admin</p>
<div class="paragraph">
<p>[ Cannot use system: users, so must reference an unexistant "admin" user ]</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ oc --kubeconfig ~/local-admin whoami
system:admin
$ oc --kubeconfig ~/local-admin create clusterrolebinding cluster-admin-user --clusterrole cluster-admin --user admin
clusterrolebinding.rbac.authorization.k8s.io/cluster-admin-user created
$ oc --kubeconfig ~/local-admin create clusterrole sudo-admin --resource users --resource-name admin --verb impersonate
clusterrole.rbac.authorization.k8s.io/sudo-admin created
$ oc --kubeconfig ~/local-admin create clusterrolebinding sudo-user --clusterrole sudo-admin --serviceaccount user:user
clusterrolebinding.rbac.authorization.k8s.io/sudo-user created
$ oc --kubeconfig ~/remote-user whoami
system:serviceaccount:user:user
$ oc --kubeconfig ~/remote-user get nodes
Error from server (Forbidden): nodes is forbidden: User "system:serviceaccount:user:user" cannot list resource "nodes" in API group "" at the cluster scope
$ oc --kubeconfig ~/remote-user --as admin get nodes
NAME      STATUS   ROLES                         AGE   VERSION
serverb   Ready    control-plane,master,worker   25h   v1.30.5</code></pre>
</div>
</div>
</li>
<li>
<p>Allow remote access to MicroShift on the system firewall and Test a kubeconfig file for remote access as cluster administrator.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ sudo cp /var/lib/microshift/resources/kubeadmin/serverb/kubeconfig ~/remote-admin
$ sudo chown student:student ~/remote-admin
$ chmod a-w ~/remote-admin
$ oc --kubeconfig ~/remote-admin get node
NAME      STATUS   ROLES                         AGE   VERSION
serverb   Ready    control-plane,master,worker   23h   v1.30.5
$ sudo firewall-cmd --permanent --zone=public --add-port=6443/tcp
success
$ sudo firewall-cmd --reload
success</code></pre>
</div>
</div>
</li>
<li>
<p>Switch to your <em>development machine</em> and copy the kubeconfig files for cluster administrator and service account.</p>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-none hljs">$ scp serverb:~/remote-admin .
$ chmod a-w ~/remote-admin
[student@workstation ~]$ oc --kubeconfig ~/remote-admin get node
NAME      STATUS   ROLES                         AGE   VERSION
serverb   Ready    control-plane,master,worker   24h   v1.30.5
[student@workstation ~]$ oc --kubeconfig ~/remote-user get configmap
NAME                       DATA   AGE
kube-root-ca.crt           1      115m
openshift-service-ca.crt   1      115m
test                       1      100m
[student@workstation ~]$ oc --kubeconfig ~/remote-user get configmap -n project
NAME                       DATA   AGE
kube-root-ca.crt           1      99m
openshift-service-ca.crt   1      99m
test2                      1      98m
$ oc --kubeconfig ~/remote-user --as admin get node
NAME      STATUS   ROLES                         AGE   VERSION
serverb   Ready    control-plane,master,worker   25h   v1.30.5</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>You now have [ SOMETHING ] or did [ SOMETHING ]</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_next_steps"><a class="anchor" href="#_next_steps"></a>Next Steps</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Lorem ipsum</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="s2-install-lab.html">Lab: Install MicroShift from RPM Packages</a></span>
  <span class="next"><a href="../ch3-image/index.html">Deploy MicroShift on Edge Devices</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <img src="../../../_/img/rhl-logo-red.png" height="40px" alt="Red Hat"  href="https://redhat.com" >
</footer><script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
  </body>
</html>
